<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Escala da Igreja</title>
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css' rel='stylesheet' />
  <link rel="stylesheet" href="style.css" />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
</head>
<body>
  <div class="conteudo">
    <div class="filtro" style="text-align:center; margin-bottom: 1rem;">
      <label for="filtroEquipe" style="color: #fff; font-weight: bold;">Filtrar por Equipe:</label>
      <select id="filtroEquipe" onchange="filtrarCalendario()" style="margin-left: 10px; padding: 0.4rem; border-radius: 6px;">
        <option value="">Todas</option>
      </select>
    </div>

    <div id="calendario"></div>

    <div id="avisoArea" style="display: none">
      <h2>Aviso</h2>
      <div id="avisoDisplayTexto"></div>
    </div>
  </div>

  <script>
    const API_URL = 'https://sheetdb.io/api/v1/w34uix9m94kl8';
    const API_ESCALAS = `${API_URL}?sheet=escalas`;
    const API_AVISOS = `${API_URL}?sheet=avisos`;

    let todasEscalas = [];
    let todosAvisos = [];
    let nomesEquipe = new Set();
    let calendario;

    document.addEventListener('DOMContentLoaded', async function () {
      const calendarioEl = document.getElementById('calendario');

      await carregarEventos();

      calendario = new FullCalendar.Calendar(calendarioEl, {
        initialView: 'dayGridMonth',
        locale: 'pt-br',
        events: gerarEventosCalendario(),
        eventClick: function (info) {
          const aviso = info.event.extendedProps.aviso;
          if (aviso) {
            document.getElementById('avisoDisplayTexto').innerText = aviso;
            document.getElementById('avisoArea').style.display = 'block';
            window.scrollTo({ top: document.getElementById('avisoArea').offsetTop - 50, behavior: 'smooth' });
          }
        }
      });

      calendario.render();
      preencherFiltroEquipes();
    });

    async function carregarEventos() {
      try {
        const [resEscalas, resAvisos] = await Promise.all([
          fetch(API_ESCALAS),
          fetch(API_AVISOS)
        ]);

        todasEscalas = await resEscalas.json();
        todosAvisos = await resAvisos.json();

        todasEscalas.forEach(e => nomesEquipe.add(e.nome));
      } catch (err) {
        console.error('Erro ao carregar eventos:', err);
      }
    }

    function gerarEventosCalendario(filtroNome = '') {
      const eventosEscala = todasEscalas
        .filter(e => !filtroNome || e.nome === filtroNome)
        .map(e => ({
          title: `Escala: ${e.nome}`,
          start: e.data,
          color: '#42a5f5'
        }));

      const eventosAviso = todosAvisos.map(e => ({
        title: 'ðŸ”” Aviso',
        start: e.data,
        color: '#f39c12',
        aviso: e.aviso
      }));

      return [...eventosEscala, ...eventosAviso];
    }

    function filtrarCalendario() {
      const filtro = document.getElementById('filtroEquipe').value;
      calendario.removeAllEvents();
      calendario.addEventSource(gerarEventosCalendario(filtro));
    }

    function preencherFiltroEquipes() {
      const select = document.getElementById('filtroEquipe');
      nomesEquipe.forEach(nome => {
        const option = document.createElement('option');
        option.value = nome;
        option.textContent = nome;
        select.appendChild(option);
      });
    }
  </script>
</body>
</html>
